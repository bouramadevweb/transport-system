<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Modal & Aper√ßu - Stationnement</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .test-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-4">
            <h1><i class="fas fa-flask me-2"></i>Test Modal & Aper√ßu Temps R√©el</h1>
            <p class="text-muted">V√©rification des fonctionnalit√©s UX du syst√®me de stationnement</p>
        </div>

        <!-- Section de test -->
        <div class="test-section">
            <h3><i class="fas fa-calendar me-2"></i>S√©lectionner Date de D√©chargement</h3>
            <p class="text-muted">S√©lectionnez une date pour voir l'aper√ßu en temps r√©el</p>

            <div class="row mb-4">
                <div class="col-md-6">
                    <label for="date_arrivee" class="form-label">Date d'arriv√©e (fixe pour le test)</label>
                    <input type="date" id="date_arrivee" class="form-control" value="2024-12-18" readonly>
                    <small class="text-muted">Lundi 18 d√©cembre 2024</small>
                </div>
                <div class="col-md-6">
                    <label for="date_dechargement" class="form-label">Date de d√©chargement <span class="text-danger">*</span></label>
                    <input type="date" id="date_dechargement" class="form-control" value="2024-12-26">
                    <small class="text-muted">Changez cette date pour voir l'aper√ßu se mettre √† jour</small>
                </div>
            </div>

            <button type="button" class="btn btn-success" id="btnPreviewDechargement">
                <i class="fas fa-eye me-1"></i>Aper√ßu et Confirmation
            </button>
        </div>

        <!-- Aper√ßu en temps r√©el -->
        <div class="card shadow-sm border-0 mb-4" id="cardApercu" style="display: none;">
            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h5 class="mb-0 text-white">
                    <i class="fas fa-eye me-2"></i>Aper√ßu en temps r√©el
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="text-center p-3 bg-light rounded">
                            <small class="text-muted d-block">Jours total</small>
                            <h4 class="mb-0" id="liveJoursTotal">‚Äî</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 bg-light rounded">
                            <small class="text-muted d-block">Jours gratuits</small>
                            <h4 class="mb-0 text-success" id="liveJoursGratuits">‚Äî</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 bg-light rounded">
                            <small class="text-muted d-block">Jours facturables</small>
                            <h4 class="mb-0 text-danger" id="liveJoursFacturables">‚Äî</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 bg-warning bg-opacity-25 rounded">
                            <small class="text-muted d-block">Montant total</small>
                            <h4 class="mb-0 text-danger" id="liveMontantTotal">‚Äî</h4>
                        </div>
                    </div>
                </div>
                <hr>
                <div id="liveMessage" class="text-center">
                    S√©lectionnez une date pour voir le calcul
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle me-2"></i>Instructions de Test</h5>
            <ol class="mb-0">
                <li>Changez la <strong>date de d√©chargement</strong> ci-dessus</li>
                <li>Observez la carte <strong>"Aper√ßu en temps r√©el"</strong> appara√Ætre et se mettre √† jour</li>
                <li>Cliquez sur <strong>"Aper√ßu et Confirmation"</strong> pour voir le modal d√©taill√©</li>
                <li>V√©rifiez que les calculs sont corrects dans les deux vues</li>
            </ol>
        </div>

        <!-- R√©sultats de test -->
        <div class="test-section">
            <h4><i class="fas fa-clipboard-check me-2"></i>Checklist de Test</h4>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="check1">
                <label class="form-check-label" for="check1">
                    Carte aper√ßu appara√Æt automatiquement lors du changement de date
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="check2">
                <label class="form-check-label" for="check2">
                    Les 4 m√©triques sont affich√©es (jours total, gratuits, facturables, montant)
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="check3">
                <label class="form-check-label" for="check3">
                    Le message en bas change selon le r√©sultat (gratuit vs payant)
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="check4">
                <label class="form-check-label" for="check4">
                    Le modal s'ouvre avec le bouton "Aper√ßu et Confirmation"
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="check5">
                <label class="form-check-label" for="check5">
                    Le modal affiche 3 cartes (p√©riode, frais, d√©tail)
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="check6">
                <label class="form-check-label" for="check6">
                    Les calculs sont corrects et coh√©rents entre aper√ßu et modal
                </label>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation -->
    <div class="modal fade" id="modalConfirmationDechargement" tabindex="-1" aria-labelledby="modalConfirmationLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="modalConfirmationLabel">
                        <i class="fas fa-calculator me-2"></i>Aper√ßu des frais de stationnement
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>V√©rifiez les frais calcul√©s avant de confirmer le d√©chargement</strong>
                    </div>

                    <!-- Carte 1: P√©riode -->
                    <div class="card mb-3 border-primary">
                        <div class="card-header bg-primary text-white">
                            <i class="fas fa-calendar-alt me-2"></i>P√©riode de stationnement
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <small class="text-muted d-block">Date d'arriv√©e</small>
                                    <strong class="text-success" id="previewDateArrivee">‚Äî</strong>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted d-block">Date de d√©chargement</small>
                                    <strong class="text-danger" id="previewDateDechargement">‚Äî</strong>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <small class="text-muted d-block">Jours total</small>
                                    <strong id="previewJoursTotal">0</strong> jour(s)
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted d-block">Jours gratuits utilis√©s</small>
                                    <strong class="text-success" id="previewJoursGratuits">0</strong> jour(s)
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Carte 2: Frais -->
                    <div class="card mb-3 border-danger">
                        <div class="card-header bg-danger text-white">
                            <i class="fas fa-money-bill-wave me-2"></i>Frais de stationnement
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <small class="text-muted d-block">Jours facturables</small>
                                    <strong class="text-danger fs-4" id="previewJoursFacturables">0</strong> jour(s)
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted d-block">Tarif journalier</small>
                                    <strong>25 000 CFA</strong>
                                </div>
                            </div>
                            <hr>
                            <div class="text-center">
                                <small class="text-muted d-block">Montant total √† facturer</small>
                                <h2 class="text-danger mb-0" id="previewMontantTotal">0 CFA</h2>
                            </div>
                        </div>
                    </div>

                    <!-- Carte 3: D√©tail -->
                    <div class="card border-secondary">
                        <div class="card-header bg-secondary text-white">
                            <i class="fas fa-list-ul me-2"></i>D√©tail du calcul
                        </div>
                        <div class="card-body">
                            <div id="previewDetailsCalcul" class="small">
                                <!-- Rempli par JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Fermer
                    </button>
                    <button type="button" class="btn btn-success" id="btnConfirmerDechargement">
                        <i class="fas fa-check-circle me-1"></i>Confirmer (Test)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript de test -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dateArriveeInput = document.getElementById('date_arrivee');
            const dateInput = document.getElementById('date_dechargement');
            const btnPreview = document.getElementById('btnPreviewDechargement');
            const btnConfirm = document.getElementById('btnConfirmerDechargement');
            const modal = new bootstrap.Modal(document.getElementById('modalConfirmationDechargement'));

            // √âl√©ments aper√ßu temps r√©el
            const cardApercu = document.getElementById('cardApercu');
            const liveJoursTotal = document.getElementById('liveJoursTotal');
            const liveJoursGratuits = document.getElementById('liveJoursGratuits');
            const liveJoursFacturables = document.getElementById('liveJoursFacturables');
            const liveMontantTotal = document.getElementById('liveMontantTotal');
            const liveMessage = document.getElementById('liveMessage');

            // Date d'arriv√©e fixe
            const dateArrivee = new Date(dateArriveeInput.value);

            // Fonctions utilitaires
            function isWeekend(date) {
                const day = date.getDay();
                return day === 0 || day === 6;
            }

            function addDays(date, days) {
                const result = new Date(date);
                result.setDate(result.getDate() + days);
                return result;
            }

            function countBusinessDays(startDate, endDate) {
                let count = 0;
                let currentDate = new Date(startDate);

                while (currentDate <= endDate) {
                    if (!isWeekend(currentDate)) {
                        count++;
                    }
                    currentDate = addDays(currentDate, 1);
                }

                return count;
            }

            function countTotalDays(startDate, endDate) {
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays + 1;
            }

            // Calcul principal
            function calculateFees(dateArrivee, dateDechargement) {
                // D√©but p√©riode gratuite
                let debutGratuit = new Date(dateArrivee);
                while (isWeekend(debutGratuit)) {
                    debutGratuit = addDays(debutGratuit, 1);
                }

                // Fin p√©riode gratuite (3 jours ouvrables)
                let joursGratuitsComptes = 0;
                let currentDate = new Date(debutGratuit);
                let finGratuit = null;

                while (joursGratuitsComptes < 3) {
                    if (!isWeekend(currentDate)) {
                        joursGratuitsComptes++;
                        if (joursGratuitsComptes === 3) {
                            finGratuit = new Date(currentDate);
                            break;
                        }
                    }
                    currentDate = addDays(currentDate, 1);
                }

                // D√©but facturation
                const debutFacturation = addDays(finGratuit, 1);

                // Jours facturables
                let joursFacturables = 0;
                if (dateDechargement >= debutFacturation) {
                    const diffTime = Math.abs(dateDechargement - debutFacturation);
                    joursFacturables = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                }

                // Montant
                const tarifJournalier = 25000;
                const montantTotal = joursFacturables * tarifJournalier;

                // Stats
                const joursTotal = countTotalDays(dateArrivee, dateDechargement);
                const joursOuvrablesTotal = countBusinessDays(dateArrivee, dateDechargement);
                const joursGratuitsUtilises = Math.min(3, joursOuvrablesTotal);

                return {
                    debutGratuit,
                    finGratuit,
                    debutFacturation,
                    joursTotal,
                    joursGratuitsUtilises,
                    joursFacturables,
                    montantTotal,
                    tarifJournalier
                };
            }

            function formatDate(date) {
                const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
                return date.toLocaleDateString('fr-FR', options);
            }

            function formatCFA(montant) {
                return montant.toLocaleString('fr-FR') + ' CFA';
            }

            // Mise √† jour aper√ßu temps r√©el
            function updateLivePreview(dateDechargement) {
                if (!dateDechargement) {
                    cardApercu.style.display = 'none';
                    return;
                }

                cardApercu.style.display = 'block';

                const calcul = calculateFees(dateArrivee, dateDechargement);

                liveJoursTotal.textContent = calcul.joursTotal;
                liveJoursGratuits.textContent = calcul.joursGratuitsUtilises;
                liveJoursFacturables.textContent = calcul.joursFacturables;
                liveMontantTotal.textContent = formatCFA(calcul.montantTotal);

                if (calcul.joursFacturables === 0) {
                    liveMessage.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i><strong class="text-success">Aucun frais - D√©chargement dans la p√©riode gratuite</strong>';
                } else {
                    liveMessage.innerHTML = '<i class="fas fa-money-bill-wave text-danger me-2"></i><strong class="text-danger">' + calcul.joursFacturables + ' jour(s) √ó 25 000 CFA = ' + formatCFA(calcul.montantTotal) + '</strong>';
                }
            }

            // Mise √† jour modal
            function updatePreview() {
                const dateDechargement = new Date(dateInput.value);

                if (!dateInput.value) {
                    return;
                }

                const calcul = calculateFees(dateArrivee, dateDechargement);

                // Dates
                document.getElementById('previewDateArrivee').textContent = formatDate(dateArrivee);
                document.getElementById('previewDateDechargement').textContent = formatDate(dateDechargement);

                // Jours
                document.getElementById('previewJoursTotal').textContent = calcul.joursTotal;
                document.getElementById('previewJoursGratuits').textContent = calcul.joursGratuitsUtilises;
                document.getElementById('previewJoursFacturables').textContent = calcul.joursFacturables;

                // Montant
                document.getElementById('previewMontantTotal').textContent = formatCFA(calcul.montantTotal);

                // D√©tail
                let detailHTML = '<ul class="mb-0">';
                detailHTML += `<li>‚úÖ Arriv√©e du camion: <strong>${formatDate(dateArrivee)}</strong></li>`;

                if (isWeekend(dateArrivee)) {
                    detailHTML += `<li>‚ÑπÔ∏è Arriv√©e le weekend ‚Üí P√©riode gratuite commence le <strong>${formatDate(calcul.debutGratuit)}</strong></li>`;
                } else {
                    detailHTML += `<li>‚ÑπÔ∏è P√©riode gratuite commence: <strong>${formatDate(calcul.debutGratuit)}</strong></li>`;
                }

                detailHTML += `<li>‚úÖ 3 jours gratuits jusqu'au: <strong>${formatDate(calcul.finGratuit)}</strong></li>`;

                if (calcul.joursFacturables > 0) {
                    detailHTML += `<li>üí∞ Facturation commence le: <strong>${formatDate(calcul.debutFacturation)}</strong></li>`;
                    detailHTML += `<li>üìÖ D√©chargement: <strong>${formatDate(dateDechargement)}</strong></li>`;
                    detailHTML += `<li>üî¢ Calcul: ${calcul.joursFacturables} jour(s) √ó ${formatCFA(calcul.tarifJournalier)} = <strong class="text-danger">${formatCFA(calcul.montantTotal)}</strong></li>`;
                } else {
                    detailHTML += `<li>‚úÖ D√©chargement dans la p√©riode gratuite</li>`;
                    detailHTML += `<li>üéâ <strong class="text-success">Aucun frais √† facturer!</strong></li>`;
                }

                detailHTML += '</ul>';

                document.getElementById('previewDetailsCalcul').innerHTML = detailHTML;
            }

            // Events
            btnPreview.addEventListener('click', function() {
                if (!dateInput.value) {
                    alert('Veuillez s√©lectionner une date de d√©chargement');
                    dateInput.focus();
                    return;
                }

                updatePreview();
                modal.show();
            });

            btnConfirm.addEventListener('click', function() {
                alert('‚úÖ Test r√©ussi! En production, le formulaire serait soumis ici.');
                modal.hide();
            });

            dateInput.addEventListener('change', function() {
                if (document.getElementById('modalConfirmationDechargement').classList.contains('show')) {
                    updatePreview();
                }
                updateLivePreview(new Date(dateInput.value));
            });

            // Initial
            if (dateInput.value) {
                updateLivePreview(new Date(dateInput.value));
            }
        });
    </script>
</body>
</html>
