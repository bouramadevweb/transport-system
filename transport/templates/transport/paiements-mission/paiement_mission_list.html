{% extends "admin.html" %}

{% block page_title %}Liste des Paiements | Gestion Transport{% endblock %}

{% block title %}Liste des Paiements{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-3 mb-4">
        <h2 class="mb-0"><i class="fas fa-credit-card text-primary me-2"></i>{{ title }}</h2>
        <div class="d-flex gap-2 w-100 w-sm-auto">
            <!-- Export buttons -->
            <a href="{% url 'export_paiements_excel' %}?{{ request.GET.urlencode }}" class="btn btn-outline-success" title="Exporter en Excel">
                <i class="fas fa-file-excel me-1"></i>Excel
            </a>
            <a href="{% url 'export_paiements_csv' %}?{{ request.GET.urlencode }}" class="btn btn-outline-info" title="Exporter en CSV">
                <i class="fas fa-file-csv me-1"></i>CSV
            </a>
            <a href="{% url 'rapport_paiements_pdf' %}?{{ request.GET.urlencode }}" class="btn btn-outline-danger" title="Rapport PDF">
                <i class="fas fa-file-pdf me-1"></i>PDF
            </a>
            <a href="{% url 'create_paiement_mission' %}" class="btn btn-primary flex-grow-1 flex-sm-grow-0">
                <i class="fas fa-plus me-1"></i> Nouveau paiement
            </a>
        </div>
    </div>

    <!-- Filtres avancés -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-light">
            <h6 class="mb-0">
                <i class="fas fa-filter me-2"></i>Filtres de recherche
                <button class="btn btn-sm btn-link float-end" type="button" data-bs-toggle="collapse" data-bs-target="#filterForm">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </h6>
        </div>
        <div class="collapse show" id="filterForm">
            <div class="card-body">
                <form method="get" id="dateFilterForm" class="row g-3">
                    <!-- Recherche textuelle -->
                    <div class="col-12 col-md-3">
                        <label for="search" class="form-label small fw-semibold">
                            <i class="fas fa-search text-primary me-1"></i>Recherche
                        </label>
                        <input type="text" class="form-control" id="search" name="search"
                               placeholder="ID paiement ou mission..."
                               value="{{ filters.search|default:'' }}">
                    </div>

                    <!-- Statut validation -->
                    <div class="col-12 col-md-2">
                        <label for="est_valide" class="form-label small fw-semibold">
                            <i class="fas fa-check-circle text-primary me-1"></i>Validation
                        </label>
                        <select class="form-select" id="est_valide" name="est_valide">
                            <option value="" {% if not filters.est_valide %}selected{% endif %}>Tous</option>
                            <option value="oui" {% if filters.est_valide == 'oui' %}selected{% endif %}>✅ Validés</option>
                            <option value="non" {% if filters.est_valide == 'non' %}selected{% endif %}>⏳ En attente</option>
                        </select>
                    </div>

                    <!-- Chauffeur -->
                    <div class="col-12 col-md-3">
                        <label for="chauffeur" class="form-label small fw-semibold">
                            <i class="fas fa-user text-primary me-1"></i>Chauffeur
                        </label>
                        <select class="form-select" id="chauffeur" name="chauffeur">
                            <option value="">Tous les chauffeurs</option>
                            {% for c in chauffeurs %}
                            <option value="{{ c.pk_chauffeur }}" {% if filters.chauffeur == c.pk_chauffeur %}selected{% endif %}>
                                {{ c.nom }} {{ c.prenom }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Montant minimum -->
                    <div class="col-12 col-md-2">
                        <label for="montant_min" class="form-label small fw-semibold">
                            <i class="fas fa-money-bill-wave text-primary me-1"></i>Montant min
                        </label>
                        <input type="number" class="form-control" id="montant_min" name="montant_min"
                               placeholder="0" value="{{ filters.montant_min|default:'' }}">
                    </div>

                    <!-- Montant maximum -->
                    <div class="col-12 col-md-2">
                        <label for="montant_max" class="form-label small fw-semibold">
                            <i class="fas fa-money-bill-wave text-primary me-1"></i>Montant max
                        </label>
                        <input type="number" class="form-control" id="montant_max" name="montant_max"
                               placeholder="∞" value="{{ filters.montant_max|default:'' }}">
                    </div>

                    <!-- Date début -->
                    <div class="col-12 col-md-3">
                        <label for="date_debut" class="form-label small fw-semibold">
                            <i class="fas fa-calendar-alt text-primary me-1"></i>Date de début
                        </label>
                        <input type="date" class="form-control" id="date_debut" name="date_debut"
                               value="{{ filters.date_debut|default:'' }}">
                    </div>

                    <!-- Date fin -->
                    <div class="col-12 col-md-3">
                        <label for="date_fin" class="form-label small fw-semibold">
                            <i class="fas fa-calendar-check text-primary me-1"></i>Date de fin
                        </label>
                        <input type="date" class="form-control" id="date_fin" name="date_fin"
                               value="{{ filters.date_fin|default:'' }}">
                    </div>

                    <!-- Boutons -->
                    <div class="col-12 col-md-6">
                        <label class="form-label small fw-semibold text-white">.</label>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary flex-grow-1">
                                <i class="fas fa-filter me-1"></i>Filtrer
                            </button>
                            <button type="button" onclick="resetFilters()" class="btn btn-outline-secondary">
                                <i class="fas fa-redo me-1"></i>Réinitialiser
                            </button>
                        </div>
                    </div>

                    <!-- Quick filter buttons -->
                    <div class="col-12">
                        <label class="form-label small fw-semibold">Raccourcis de date:</label>
                        <div class="btn-group btn-group-sm flex-wrap" role="group">
                            <button type="button" class="btn btn-outline-info" onclick="setQuickFilter(7)">
                                <i class="fas fa-calendar-week me-1"></i>7 derniers jours
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="setQuickFilter(30)">
                                <i class="fas fa-calendar-day me-1"></i>30 derniers jours
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="setQuickFilter(90)">
                                <i class="fas fa-calendar me-1"></i>3 derniers mois
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="setQuickFilter(365)">
                                <i class="fas fa-calendar-alt me-1"></i>Année en cours
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Info filtres actifs -->
                {% if filters.search or filters.est_valide or filters.chauffeur or filters.montant_min or filters.montant_max or filters.date_debut or filters.date_fin %}
                <div class="mt-3 p-2 bg-info bg-opacity-10 rounded">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i><strong>Filtres actifs:</strong>
                        {% if filters.search %}<span class="badge bg-primary ms-1">Recherche: "{{ filters.search }}"</span>{% endif %}
                        {% if filters.est_valide == 'oui' %}<span class="badge bg-success ms-1">Validés</span>{% endif %}
                        {% if filters.est_valide == 'non' %}<span class="badge bg-warning ms-1">En attente</span>{% endif %}
                        {% if filters.chauffeur %}<span class="badge bg-info ms-1">Chauffeur filtré</span>{% endif %}
                        {% if filters.montant_min %}<span class="badge bg-secondary ms-1">Min: {{ filters.montant_min }} FCFA</span>{% endif %}
                        {% if filters.montant_max %}<span class="badge bg-secondary ms-1">Max: {{ filters.montant_max }} FCFA</span>{% endif %}
                        {% if filters.date_debut %}<span class="badge bg-secondary ms-1">Du {{ filters.date_debut }}</span>{% endif %}
                        {% if filters.date_fin %}<span class="badge bg-secondary ms-1">Au {{ filters.date_fin }}</span>{% endif %}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-sm-6 col-lg-4">
            <div class="card border-success shadow-sm h-100">
                <div class="card-body text-center py-3">
                    <h3 class="text-success mb-2">{{ paiements_valides.count }}</h3>
                    <p class="text-muted mb-0 small"><i class="fas fa-check-circle me-1"></i>Validés</p>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-4">
            <div class="card border-warning shadow-sm h-100">
                <div class="card-body text-center py-3">
                    <h3 class="text-warning mb-2">{{ paiements_attente.count }}</h3>
                    <p class="text-muted mb-0 small"><i class="fas fa-clock me-1"></i>En attente</p>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-4">
            <div class="card border-primary shadow-sm h-100">
                <div class="card-body text-center py-3">
                    <h3 class="text-primary mb-2">{{ paiements.count }}</h3>
                    <p class="text-muted mb-0 small"><i class="fas fa-list me-1"></i>Total</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs pour filtrer -->
    <ul class="nav nav-tabs mb-3" id="paiementTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab">
                <i class="fas fa-list me-1"></i>Tous ({{ paiements.count }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="attente-tab" data-bs-toggle="tab" data-bs-target="#attente" type="button" role="tab">
                <i class="fas fa-clock me-1"></i>En attente ({{ paiements_attente.count }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="valides-tab" data-bs-toggle="tab" data-bs-target="#valides" type="button" role="tab">
                <i class="fas fa-check-circle me-1"></i>Validés ({{ paiements_valides.count }})
            </button>
        </li>
    </ul>

    <div class="tab-content" id="paiementTabsContent">
        <!-- Tous les paiements -->
        <div class="tab-pane fade show active" id="all" role="tabpanel">
            {% if paiements %}
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th><i class="fas fa-info-circle me-2"></i>Statut</th>
                                    <th><i class="fas fa-route me-2"></i>Mission</th>
                                    <th><i class="fas fa-dollar-sign me-2"></i>Montant Total</th>
                                    <th><i class="fas fa-parking me-2"></i>Frais Stationnement</th>
                                    <th><i class="fas fa-percentage me-2"></i>Commission</th>
                                    <th><i class="fas fa-calendar me-2"></i>Date</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for paiement in paiements %}
                                <tr>
                                    <td>
                                        {% if paiement.est_valide %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check-circle me-1"></i>Validé
                                            </span>
                                        {% else %}
                                            <span class="badge bg-warning">
                                                <i class="fas fa-clock me-1"></i>En attente
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div>
                                            <small class="text-muted d-block">{{ paiement.mission.pk_mission|slice:":20" }}...</small>
                                            <strong>{{ paiement.mission.origine }}</strong> → <strong>{{ paiement.mission.destination }}</strong>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="text-success fw-bold">{{ paiement.montant_total|floatformat:0 }} CFA</span>
                                    </td>
                                    <td>
                                        {% if paiement.frais_stationnement > 0 %}
                                            <span class="text-danger fw-bold">{{ paiement.frais_stationnement|floatformat:0 }} CFA</span>
                                            {% if paiement.mission.jours_stationnement_facturables %}
                                                <br><small class="text-muted">({{ paiement.mission.jours_stationnement_facturables }} jour{{ paiement.mission.jours_stationnement_facturables|pluralize }})</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ paiement.commission_transitaire|floatformat:0 }} CFA</td>
                                    <td>{{ paiement.date_paiement|date:"d/m/Y" }}</td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            {% if not paiement.est_valide %}
                                                <button type="button"
                                                        class="btn btn-sm btn-primary btn-validate-payment"
                                                        data-paiement-id="{{ paiement.pk_paiement }}"
                                                        title="Valider le paiement">
                                                    <i class="fas fa-check-circle"></i>
                                                </button>
                                            {% endif %}
                                            <a href="{% url 'update_paiement_mission' paiement.pk_paiement %}"
                                               class="btn btn-sm btn-outline-warning"
                                               title="Modifier">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{% url 'delete_paiement_mission' paiement.pk_paiement %}"
                                               class="btn btn-sm btn-outline-danger"
                                               title="Supprimer">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            {% with page_obj=paiements %}
                {% include 'includes/pagination.html' %}
            {% endwith %}
            {% else %}
            <div class="alert alert-info shadow-sm">
                <i class="fas fa-info-circle me-2"></i>
                Aucun paiement enregistré. <a href="{% url 'create_paiement_mission' %}" class="alert-link">Ajouter le premier</a>
            </div>
            {% endif %}
        </div>

        <!-- Paiements en attente -->
        <div class="tab-pane fade" id="attente" role="tabpanel">
            {% if paiements_attente %}
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th><i class="fas fa-route me-2"></i>Mission</th>
                                    <th><i class="fas fa-info-circle me-2"></i>Statut Mission</th>
                                    <th><i class="fas fa-dollar-sign me-2"></i>Montant Total</th>
                                    <th><i class="fas fa-parking me-2"></i>Frais Stationnement</th>
                                    <th><i class="fas fa-calendar me-2"></i>Date création</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for paiement in paiements_attente %}
                                <tr>
                                    <td>
                                        <div>
                                            <small class="text-muted d-block">{{ paiement.mission.pk_mission|slice:":20" }}...</small>
                                            <strong>{{ paiement.mission.origine }}</strong> → <strong>{{ paiement.mission.destination }}</strong>
                                        </div>
                                    </td>
                                    <td>
                                        {% if paiement.mission.statut == 'terminée' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check-circle me-1"></i>Terminée
                                            </span>
                                        {% elif paiement.mission.statut == 'en cours' %}
                                            <span class="badge bg-warning">
                                                <i class="fas fa-spinner me-1"></i>En cours
                                            </span>
                                        {% else %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times-circle me-1"></i>Annulée
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="text-success fw-bold">{{ paiement.montant_total }}€</span>
                                    </td>
                                    <td>{{ paiement.date_paiement|date:"d/m/Y" }}</td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            {% if paiement.mission.statut == 'terminée' %}
                                                <button type="button"
                                                        class="btn btn-sm btn-primary btn-validate-payment"
                                                        data-paiement-id="{{ paiement.pk_paiement }}"
                                                        title="Valider le paiement">
                                                    <i class="fas fa-check-circle me-1"></i>Valider
                                                </button>
                                            {% else %}
                                                <a href="{% url 'terminer_mission' paiement.mission.pk_mission %}"
                                                   class="btn btn-sm btn-success"
                                                   title="Terminer la mission d'abord">
                                                    <i class="fas fa-flag-checkered me-1"></i>Terminer mission
                                                </a>
                                            {% endif %}
                                            <a href="{% url 'update_paiement_mission' paiement.pk_paiement %}"
                                               class="btn btn-sm btn-outline-warning"
                                               title="Modifier">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info shadow-sm">
                <i class="fas fa-info-circle me-2"></i>
                Aucun paiement en attente de validation.
            </div>
            {% endif %}
        </div>

        <!-- Paiements validés -->
        <div class="tab-pane fade" id="valides" role="tabpanel">
            {% if paiements_valides %}
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th><i class="fas fa-route me-2"></i>Mission</th>
                                    <th><i class="fas fa-dollar-sign me-2"></i>Montant Total</th>
                                    <th><i class="fas fa-parking me-2"></i>Frais Stationnement</th>
                                    <th><i class="fas fa-percentage me-2"></i>Commission</th>
                                    <th><i class="fas fa-calendar-check me-2"></i>Date validation</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for paiement in paiements_valides %}
                                <tr class="table-success table-success-subtle">
                                    <td>
                                        <div>
                                            <small class="text-muted d-block">{{ paiement.mission.pk_mission|slice:":20" }}...</small>
                                            <strong>{{ paiement.mission.origine }}</strong> → <strong>{{ paiement.mission.destination }}</strong>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="text-success fw-bold">{{ paiement.montant_total|floatformat:0 }} CFA</span>
                                    </td>
                                    <td>
                                        {% if paiement.frais_stationnement > 0 %}
                                            <span class="text-danger fw-bold">{{ paiement.frais_stationnement|floatformat:0 }} CFA</span>
                                            {% if paiement.mission.jours_stationnement_facturables %}
                                                <br><small class="text-muted">({{ paiement.mission.jours_stationnement_facturables }} jour{{ paiement.mission.jours_stationnement_facturables|pluralize }})</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ paiement.commission_transitaire|floatformat:0 }} CFA</td>
                                    <td>
                                        {% if paiement.date_validation %}
                                            {{ paiement.date_validation|date:"d/m/Y H:i" }}
                                        {% else %}
                                            {{ paiement.date_paiement|date:"d/m/Y" }}
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <span class="badge bg-success">
                                                <i class="fas fa-check-circle me-1"></i>Validé
                                            </span>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info shadow-sm">
                <i class="fas fa-info-circle me-2"></i>
                Aucun paiement validé.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .nav-tabs .nav-link {
        color: #6c757d;
        font-weight: 500;
    }

    .nav-tabs .nav-link.active {
        color: #2563eb;
        border-bottom: 2px solid #2563eb;
    }

    .badge {
        font-size: 0.85rem;
        padding: 0.4em 0.8em;
    }

    .table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .btn-group .btn {
        margin: 0 2px;
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
        .nav-tabs .nav-link {
            font-size: 0.85rem;
            padding: 0.5rem 0.75rem;
        }

        .card .card-body h3 {
            font-size: 1.5rem;
        }

        .table {
            font-size: 0.85rem;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .btn-group .btn {
            margin: 0;
        }
    }

    @media (max-width: 576px) {
        /* En-têtes et titres */
        h2 {
            font-size: 1.1rem !important;
        }

        h3 {
            font-size: 1.5rem !important;
        }

        /* Navigation par onglets */
        .nav-tabs {
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tabs .nav-link {
            white-space: nowrap;
            font-size: 0.85rem;
            padding: 0.5rem 0.75rem;
        }

        /* Tables */
        .table {
            font-size: 0.8rem !important;
        }

        .table th {
            font-size: 0.75rem !important;
            padding: 0.5rem 0.4rem !important;
        }

        .table td {
            padding: 0.5rem 0.4rem !important;
        }

        /* Badges */
        .badge {
            font-size: 0.7rem !important;
            padding: 0.3em 0.6em !important;
        }

        /* Groupes de boutons dans les tables */
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 100%;
        }

        .btn-group .btn {
            margin: 0 !important;
            width: 100%;
            font-size: 0.8rem;
            padding: 0.35rem 0.5rem;
        }

        /* Textes dans les cellules */
        .table small {
            font-size: 0.7rem !important;
        }

        /* Container */
        .container-fluid {
            padding-left: 0.75rem !important;
            padding-right: 0.75rem !important;
        }
    }
</style>

<script>
    // Reset date filters function
    window.resetFilters = function() {
        window.location.href = window.location.pathname;
    };

    // Quick filter function
    window.setQuickFilter = function(days) {
        const today = new Date();
        const startDate = new Date();
        startDate.setDate(today.getDate() - days);

        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        document.getElementById('date_debut').value = formatDate(startDate);
        document.getElementById('date_fin').value = formatDate(today);
        document.getElementById('dateFilterForm').submit();
    };
</script>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/paiement-ajax.js' %}"></script>
<script src="{% static 'js/validation-modal.js' %}"></script>

<!-- Diagnostic script for debugging payment validation -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log('========== DIAGNOSTIC PAIEMENT VALIDATION ==========');
    console.log('✅ DOM loaded');
    console.log('Bootstrap available:', typeof bootstrap !== 'undefined' ? '✅ YES' : '❌ NO');
    console.log('ajaxManager available:', typeof ajaxManager !== 'undefined' ? '✅ YES' : '❌ NO');
    console.log('window.ajaxManager available:', typeof window.ajaxManager !== 'undefined' ? '✅ YES' : '❌ NO');
    console.log('validationModalManager available:', typeof window.validationModalManager !== 'undefined' ? '✅ YES' : '❌ NO');

    // Check validation buttons
    const validateButtons = document.querySelectorAll('.btn-validate-payment');
    console.log('Validation buttons found:', validateButtons.length);

    if (validateButtons.length > 0) {
        console.log('First button data-paiement-id:', validateButtons[0].dataset.paiementId);
    }

    console.log('====================================================');
});
</script>
{% endblock %}
