{% extends "admin.html" %}

{% block page_title %}Liste des Contrats | Gestion Transport{% endblock %}

{% block title %}Liste des Contrats{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-3 mb-4">
        <h2 class="mb-0"><i class="fas fa-file-contract text-primary me-2"></i>{{ title }}</h2>
        <button type="button" class="btn btn-primary w-100 w-sm-auto btn-create-contrat">
            <i class="fas fa-plus me-1"></i> Ajouter un contrat
        </button>
    </div>

    <!-- Statistique simple -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-sm-6 col-md-3">
            <div class="card border-primary shadow-sm h-100">
                <div class="card-body text-center py-3">
                    <i class="fas fa-file-contract fa-2x text-primary mb-2"></i>
                    <h3 class="text-primary mb-2">{{ contrats.count }}</h3>
                    <p class="text-muted mb-0 small">Total Contrats</p>
                </div>
            </div>
        </div>
    </div>

    {% if contrats %}
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th><i class="fas fa-box me-2"></i>Conteneur</th>
                            <th><i class="fas fa-user me-2"></i>Client</th>
                            <th><i class="fas fa-dolly me-2"></i>Transitaire</th>
                            <th><i class="fas fa-building me-2"></i>Entreprise</th>
                            <th><i class="fas fa-truck me-2"></i>Camion</th>
                            <th><i class="fas fa-id-card me-2"></i>Chauffeur</th>
                            <th><i class="fas fa-calendar me-2"></i>Début</th>
                            <th><i class="fas fa-clock me-2"></i>Retour limite</th>
                            <th><i class="fas fa-money-bill me-2"></i>Caution</th>
                            <th><i class="fas fa-signature me-2"></i>Signatures</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in contrats %}
                        <tr>
                            <td>{{ c.conteneur.numero_conteneur }}</td>
                            <td>
                                {% if c.client %}
                                    {{ c.client.nom }}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if c.transitaire %}
                                    {{ c.transitaire.nom }}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>{{ c.entreprise.nom }}</td>
                            <td>{{ c.camion.immatriculation }}</td>
                            <td>{{ c.chauffeur.nom }} {{ c.chauffeur.prenom }}</td>
                            <td>{{ c.date_debut }}</td>
                            <td>{{ c.date_limite_retour }}</td>
                            <td>
                                {{ c.caution }} FCFA
                                <br>
                                <span class="badge bg-info">
                                    {{ c.statut_caution|title }}
                                </span>
                            </td>
                            <td class="signatures-cell">
                                <div class="d-flex flex-column gap-1">
                                    <small>
                                        <span class="d-none d-md-inline">Chauffeur: </span>
                                        <span class="d-md-none">Ch: </span>
                                        {% if c.signature_chauffeur %}<i class="fas fa-check text-success"></i>{% else %}<i class="fas fa-times text-danger"></i>{% endif %}
                                    </small>
                                    <small>
                                        <span class="d-none d-md-inline">Client: </span>
                                        <span class="d-md-none">Cl: </span>
                                        {% if c.signature_client %}<i class="fas fa-check text-success"></i>{% else %}<i class="fas fa-times text-danger"></i>{% endif %}
                                    </small>
                                    <small>
                                        <span class="d-none d-md-inline">Transitaire: </span>
                                        <span class="d-md-none">Tr: </span>
                                        {% if c.signature_transitaire %}<i class="fas fa-check text-success"></i>{% else %}<i class="fas fa-times text-danger"></i>{% endif %}
                                    </small>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="btn-group-vertical btn-group-sm" role="group">
                                    <button type="button"
                                            class="btn btn-outline-warning btn-edit-contrat"
                                            data-contrat-id="{{ c.pk_contrat }}"
                                            title="Modifier">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    {% if c.statut == 'actif' %}
                                    <a href="{% url 'annuler_contrat' c.pk_contrat %}"
                                       class="btn btn-outline-danger"
                                       title="Annuler ce contrat">
                                        <i class="fas fa-ban"></i>
                                    </a>
                                    {% else %}
                                    <span class="badge bg-secondary" title="Contrat {{ c.statut }}">
                                        <i class="fas fa-ban"></i> {{ c.get_statut_display }}
                                    </span>
                                    {% endif %}
                                    <a href="{% url 'delete_contrat' c.pk_contrat %}"
                                       class="btn btn-outline-danger"
                                       title="Supprimer">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                    <a href="{% url 'pdf_contrat' c.pk_contrat %}"
                                       class="btn btn-outline-secondary"
                                       target="_blank"
                                       title="PDF">
                                        <i class="fas fa-file-pdf"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info shadow-sm">
        <i class="fas fa-info-circle me-2"></i>
        Aucun contrat enregistré. <button type="button" class="btn btn-link alert-link btn-create-contrat p-0">Ajouter le premier</button>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/crud-modal.js' %}"></script>
<script src="{% static 'js/contrat-form.js' %}"></script>
<script>
// Initialize CRUD modal for contrats
const contratManager = new CrudModalManager({
    entityName: 'contrat',
    entityNameDisplay: 'Contrat',
    createUrl: '{% url "ajax_contrat_create" %}',
    updateUrlPattern: '/contrats/{id}/ajax/update/',
    listSelector: 'tbody',
    modalSize: 'modal-lg'  // Larger modal for complex form
});

// Ouvrir automatiquement le modal si des paramètres URL sont présents
const urlParams = new URLSearchParams(window.location.search);
const action = urlParams.get('action');
const contratId = urlParams.get('id');

if (action === 'create') {
    // Ouvrir le modal de création
    setTimeout(() => {
        const createBtn = document.querySelector('.btn-create-contrat');
        if (createBtn) {
            createBtn.click();
            console.log('✅ Modal de création de contrat ouvert automatiquement');
        }
        // Nettoyer l'URL pour éviter de rouvrir le modal au rafraîchissement
        window.history.replaceState({}, '', window.location.pathname);
    }, 300);
} else if (action === 'update' && contratId) {
    // Ouvrir le modal de modification
    setTimeout(() => {
        const editBtn = document.querySelector(`.btn-edit-contrat[data-contrat-id="${contratId}"]`);
        if (editBtn) {
            editBtn.click();
            console.log(`✅ Modal de modification du contrat ${contratId} ouvert automatiquement`);
        }
        // Nettoyer l'URL pour éviter de rouvrir le modal au rafraîchissement
        window.history.replaceState({}, '', window.location.pathname);
    }, 300);
}
</script>
{% endblock %}

{% block extra_css %}
<style>
    /* Amélioration responsive pour la table des contrats */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    /* Sur tablette, réduire la police */
    @media (max-width: 992px) {
        .table {
            font-size: 0.85rem;
        }

        .table th,
        .table td {
            padding: 0.5rem 0.4rem;
            white-space: nowrap;
        }
    }

    /* Sur mobile */
    @media (max-width: 768px) {
        .table {
            font-size: 0.75rem;
        }

        .table th,
        .table td {
            padding: 0.4rem 0.3rem;
        }

        /* Cacher certaines icônes dans les en-têtes */
        .table th i {
            display: none;
        }

        /* Simplifier les badges */
        .badge {
            font-size: 0.65rem;
            padding: 0.2em 0.4em;
        }

        /* Boutons d'action plus compacts */
        .btn-group-vertical .btn {
            font-size: 0.7rem;
            padding: 0.25rem 0.4rem;
        }
    }

    /* Sur très petit mobile */
    @media (max-width: 576px) {
        .table {
            font-size: 0.7rem;
        }

        .table th,
        .table td {
            padding: 0.3rem 0.25rem;
            font-size: 0.65rem;
        }

        /* Signatures sur plusieurs lignes plus compactes */
        .table td br {
            display: block;
            margin: 0.1rem 0;
        }

        /* Icônes plus petites */
        .table .fas {
            font-size: 0.75rem;
        }

        /* Card body avec moins de padding sur mobile */
        .card-body.p-0 {
            padding: 0 !important;
        }

        /* Boutons d'action encore plus compacts */
        .btn-group-vertical {
            min-width: auto;
        }

        .btn-group-vertical .btn {
            font-size: 0.65rem;
            padding: 0.2rem 0.3rem;
            min-width: 35px;
        }

        /* Conteneur avec moins de padding */
        .container-fluid {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
    }

    /* Amélioration de la lisibilité */
    .table tbody tr:hover {
        background-color: #f8f9fa;
    }

    /* Signature icons alignement */
    .table td .fas.fa-check,
    .table td .fas.fa-times {
        font-size: 0.9em;
    }

    /* Scroll horizontal indicator */
    @media (max-width: 992px) {
        .table-responsive::after {
            content: "← Faites défiler horizontalement →";
            display: block;
            text-align: center;
            font-size: 0.75rem;
            color: #6c757d;
            padding: 0.5rem;
            background: linear-gradient(to right, rgba(248,249,250,0.9), rgba(248,249,250,0.9));
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
        }
    }

    /* Signatures cell optimization */
    .signatures-cell {
        min-width: 100px;
    }

    .signatures-cell small {
        font-size: 0.75rem;
        line-height: 1.3;
    }

    @media (max-width: 768px) {
        .signatures-cell {
            min-width: 60px;
        }

        .signatures-cell small {
            font-size: 0.65rem;
        }

        .signatures-cell .gap-1 {
            gap: 0.2rem !important;
        }
    }

    /* Optimisation des colonnes de dates */
    @media (max-width: 576px) {
        .table td:nth-child(7),
        .table td:nth-child(8) {
            font-size: 0.6rem;
        }
    }

    /* Titre h2 responsive */
    @media (max-width: 576px) {
        h2 {
            font-size: 1.1rem;
        }

        h2 i {
            font-size: 1rem;
        }
    }
</style>
{% endblock %}
