<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Test Conteneur API</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        #console { background: #f5f5f5; padding: 15px; margin-top: 20px; border-radius: 4px; max-height: 400px; overflow-y: auto; }
        .log { margin-bottom: 5px; padding: 5px; border-left: 3px solid #007bff; }
        .success { background-color: #d1ecf1; border-color: #0c5460; }
        .error { background-color: #f8d7da; border-color: #721c24; }
        .warning { background-color: #fff3cd; border-color: #856404; }
    </style>
</head>
<body>
    <h1>üß™ Test API Conteneur ‚Üí Client/Transitaire</h1>

    <div class="form-group">
        <label for="id_conteneur">üì¶ Conteneur:</label>
        <select id="id_conteneur" onchange="chargerClientTransitaire()">
            <option value="">-- S√©lectionnez un conteneur --</option>
        </select>
    </div>

    <div class="form-group">
        <label for="id_client">üë§ Client:</label>
        <select id="id_client">
            <option value="">-- S√©lectionnez un client --</option>
        </select>
    </div>

    <div class="form-group">
        <label for="id_transitaire">üö¢ Transitaire:</label>
        <select id="id_transitaire">
            <option value="">-- S√©lectionnez un transitaire --</option>
        </select>
    </div>

    <div id="console">
        <h3>üìã Console de diagnostic:</h3>
        <div id="logs"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = 'log ' + type;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }

        // Charger les conteneurs disponibles
        function chargerConteneurs() {
            log('üîÑ Chargement de la liste des conteneurs...');
            fetch('/api/conteneur/list/')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('id_conteneur');
                    // Note: Vous devrez cr√©er cette API ou utiliser les donn√©es existantes
                    log('‚ö†Ô∏è API liste conteneurs non impl√©ment√©e - utilisation de donn√©es de test', 'warning');

                    // Donn√©es de test
                    select.innerHTML = `
                        <option value="">-- S√©lectionnez un conteneur --</option>
                        <option value="012563dhmkmaerskmaersksackodjiguibasackodjiguibaparticulier0022377775248">012563DHM - K-Maersk</option>
                    `;
                })
                .catch(error => {
                    log('‚ö†Ô∏è Utilisation de donn√©es de test', 'warning');
                    const select = document.getElementById('id_conteneur');
                    select.innerHTML = `
                        <option value="">-- S√©lectionnez un conteneur --</option>
                        <option value="012563dhmkmaerskmaersksackodjiguibasackodjiguibaparticulier0022377775248">012563DHM - K-Maersk</option>
                    `;
                });
        }

        function chargerClientTransitaire() {
            log('üîç Fonction chargerClientTransitaire() appel√©e');

            const conteneurSelect = document.getElementById('id_conteneur');
            const clientSelect = document.getElementById('id_client');
            const transitaireSelect = document.getElementById('id_transitaire');

            log(`üìã √âl√©ments: Conteneur=${conteneurSelect ? 'OK' : 'KO'}, Client=${clientSelect ? 'OK' : 'KO'}, Transitaire=${transitaireSelect ? 'OK' : 'KO'}`);

            if (!conteneurSelect || !clientSelect || !transitaireSelect) {
                log('‚ùå √âl√©ments manquants dans le formulaire', 'error');
                return;
            }

            const conteneurId = conteneurSelect.value;
            log(`üì¶ Conteneur s√©lectionn√©: ${conteneurId}`);

            if (!conteneurId) {
                log('‚ö†Ô∏è Aucun conteneur s√©lectionn√©', 'warning');
                return;
            }

            const apiUrl = `/api/conteneur/${conteneurId}/info/`;
            log(`üåê Appel API: ${apiUrl}`);

            fetch(apiUrl)
                .then(response => {
                    log(`üì° R√©ponse API: Status ${response.status}`, response.ok ? 'success' : 'error');
                    return response.json();
                })
                .then(data => {
                    log(`üì¶ Donn√©es re√ßues: ${JSON.stringify(data)}`);

                    if (data.success) {
                        // Client
                        if (data.client_id) {
                            log(`‚úÖ Client trouv√©: ${data.client_nom} (${data.client_id})`, 'success');
                            clientSelect.innerHTML = `<option value="${data.client_id}" selected>${data.client_nom}</option>`;
                            clientSelect.style.backgroundColor = '#d1ecf1';
                            clientSelect.style.border = '2px solid #0c5460';
                        } else {
                            log('‚ö†Ô∏è Aucun client associ√©', 'warning');
                            clientSelect.value = '';
                            clientSelect.style.backgroundColor = '#fff3cd';
                        }

                        // Transitaire
                        if (data.transitaire_id) {
                            log(`‚úÖ Transitaire trouv√©: ${data.transitaire_nom} (${data.transitaire_id})`, 'success');
                            transitaireSelect.innerHTML = `<option value="${data.transitaire_id}" selected>${data.transitaire_nom}</option>`;
                            transitaireSelect.style.backgroundColor = '#d1ecf1';
                            transitaireSelect.style.border = '2px solid #0c5460';
                        } else {
                            log('‚ö†Ô∏è Aucun transitaire associ√©', 'warning');
                            transitaireSelect.value = '';
                            transitaireSelect.style.backgroundColor = '#fff3cd';
                        }
                    } else {
                        log(`‚ùå Erreur API: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    log(`‚ùå Erreur r√©seau: ${error.message}`, 'error');
                    clientSelect.style.backgroundColor = '#f8d7da';
                    transitaireSelect.style.backgroundColor = '#f8d7da';
                });
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            log('‚úÖ Page charg√©e - Initialisation...');
            chargerConteneurs();
            log('‚úÖ Pr√™t pour les tests !', 'success');
        });
    </script>
</body>
</html>
