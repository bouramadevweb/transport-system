{% extends "admin.html" %}
{% load humanize %}

{% block title %}Rapport Client - {{ client.nom }}{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-semibold mb-0">
            <i class="fas fa-user"></i> Rapport Client : {{ client.nom }}
        </h2>
        <a href="{% url 'financial_reports' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Retour aux rapports
        </a>
    </div>

    <!-- Infos client -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-info-circle"></i> Informations Client</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3"><strong>Nom :</strong> {{ client.nom }}</div>
                <div class="col-md-3"><strong>Type :</strong>
                    <span class="badge bg-info">{{ client.get_type_client_display }}</span>
                </div>
                <div class="col-md-3"><strong>Téléphone :</strong> {{ client.telephone|default:"N/A" }}</div>
                <div class="col-md-3"><strong>Email :</strong> {{ client.email|default:"N/A" }}</div>
            </div>
        </div>
    </div>

    <!-- KPIs -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-0 text-white" style="background: linear-gradient(135deg,#667eea,#764ba2);">
                <div class="card-body">
                    <h6 class="text-white-50">Total Missions</h6>
                    <h3 class="fw-bold">{{ stats.total_missions }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 text-white" style="background: linear-gradient(135deg,#4facfe,#00f2fe);">
                <div class="card-body">
                    <h6 class="text-white-50">Missions Terminées</h6>
                    <h3 class="fw-bold">{{ stats.missions_terminee }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 text-white" style="background: linear-gradient(135deg,#fa709a,#fee140);">
                <div class="card-body">
                    <h6 class="text-white-50">Missions En cours</h6>
                    <h3 class="fw-bold">{{ stats.missions_en_cours }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 text-white" style="background: linear-gradient(135deg,#f093fb,#f5576c);">
                <div class="card-body">
                    <h6 class="text-white-50">CA Total</h6>
                    <h3 class="fw-bold">{{ stats.total_ca|floatformat:0 }}</h3>
                    <small>FCFA</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Dernières missions -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white py-3">
            <h5 class="mb-0"><i class="fas fa-route"></i> 20 Dernières Missions</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Date Départ</th>
                            <th>Origine</th>
                            <th>Destination</th>
                            <th>Statut</th>
                            <th>Date Retour</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mission in missions %}
                        <tr>
                            <td>{{ mission.date_depart|date:"d/m/Y" }}</td>
                            <td>{{ mission.origine }}</td>
                            <td>{{ mission.destination }}</td>
                            <td>
                                {% if mission.statut == 'en cours' %}
                                    <span class="badge bg-warning">En cours</span>
                                {% elif mission.statut == 'terminée' %}
                                    <span class="badge bg-success">Terminée</span>
                                {% else %}
                                    <span class="badge bg-danger">Annulée</span>
                                {% endif %}
                            </td>
                            <td>{{ mission.date_retour|date:"d/m/Y"|default:"–" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-muted py-3">Aucune mission</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Derniers paiements -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3">
            <h5 class="mb-0"><i class="fas fa-receipt"></i> 10 Derniers Paiements</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Mission</th>
                            <th class="text-end">Montant Total</th>
                            <th class="text-end">Commission</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for paiement in paiements %}
                        <tr>
                            <td>{{ paiement.date_paiement|date:"d/m/Y" }}</td>
                            <td>{{ paiement.mission.origine }} → {{ paiement.mission.destination }}</td>
                            <td class="text-end"><strong>{{ paiement.montant_total|floatformat:0 }} FCFA</strong></td>
                            <td class="text-end text-danger">{{ paiement.commission_transitaire|floatformat:0 }} FCFA</td>
                            <td>
                                {% if paiement.est_valide %}
                                    <span class="badge bg-success">Validé</span>
                                {% else %}
                                    <span class="badge bg-warning">En attente</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-muted py-3">Aucun paiement</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
