{% extends 'admin.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .dashboard-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .kpi-card {
        text-align: center;
        padding: 20px;
        border-radius: 8px;
        color: white;
        transition: transform 0.2s;
    }

    .kpi-card:hover {
        transform: translateY(-5px);
    }

    .kpi-card h3 {
        font-size: 2.5em;
        margin: 10px 0;
        font-weight: bold;
    }

    .kpi-card p {
        font-size: 1em;
        opacity: 0.9;
        margin: 0;
    }

    .bg-success { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .bg-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .bg-warning { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .bg-primary { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }

    .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
    }

    .filter-bar {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-chart-bar"></i> {{ title }}</h1>

        <!-- Filtres de période -->
        <div class="filter-bar">
            <form method="get" class="d-flex align-items-center gap-2">
                <label class="mb-0">Période:</label>
                <select name="period" class="form-select form-select-sm" onchange="this.form.submit()" style="width: auto;">
                    <option value="7" {% if filter_period == '7' %}selected{% endif %}>7 jours</option>
                    <option value="30" {% if filter_period == '30' %}selected{% endif %}>30 jours</option>
                    <option value="90" {% if filter_period == '90' %}selected{% endif %}>90 jours</option>
                    <option value="365" {% if filter_period == '365' %}selected{% endif %}>1 an</option>
                    <option value="all" {% if filter_period == 'all' %}selected{% endif %}>Tout</option>
                </select>
            </form>
        </div>
    </div>

    <!-- KPIs Financiers -->
    <div class="stats-grid">
        <div class="kpi-card bg-success">
            <p>CA Total</p>
            <h3>{{ ca_total|floatformat:0 }}</h3>
            <small>FCFA</small>
        </div>

        <div class="kpi-card bg-info">
            <p>CA Net</p>
            <h3>{{ ca_net|floatformat:0 }}</h3>
            <small>FCFA (après commissions)</small>
        </div>

        <div class="kpi-card bg-warning">
            <p>CA Moyen</p>
            <h3>{{ ca_moyen|floatformat:0 }}</h3>
            <small>FCFA par mission</small>
        </div>

        <div class="kpi-card bg-primary">
            <p>Paiements Validés</p>
            <h3>{{ nb_paiements }}</h3>
            <small>paiements</small>
        </div>
    </div>

    <div class="row">
        <!-- Graphique: CA par semaine -->
        <div class="col-md-12">
            <div class="dashboard-card">
                <h4>Évolution du CA par semaine (8 dernières semaines)</h4>
                <div class="chart-container">
                    <canvas id="chartCASemaine"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <!-- Top clients par CA -->
        <div class="col-md-8">
            <div class="dashboard-card">
                <h4>Top 10 Clients par Chiffre d'Affaires</h4>
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Client</th>
                            <th>Type</th>
                            <th class="text-end">CA (FCFA)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for client in top_clients_ca %}
                        {% if client.ca %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ client.nom }}</td>
                            <td><span class="badge bg-secondary">{{ client.get_type_client_display }}</span></td>
                            <td class="text-end"><strong>{{ client.ca|floatformat:0 }}</strong></td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Répartition CA -->
        <div class="col-md-4">
            <div class="dashboard-card">
                <h4>Répartition CA par Type</h4>
                <table class="table table-sm">
                    <tr>
                        <td><strong>Entreprises</strong></td>
                        <td class="text-end">{{ ca_entreprises|floatformat:0 }} FCFA</td>
                    </tr>
                    <tr>
                        <td><strong>Particuliers</strong></td>
                        <td class="text-end">{{ ca_particuliers|floatformat:0 }} FCFA</td>
                    </tr>
                    <tr class="table-success">
                        <td><strong>Total</strong></td>
                        <td class="text-end"><strong>{{ ca_total|floatformat:0 }} FCFA</strong></td>
                    </tr>
                </table>

                <div class="mt-3">
                    {% if ca_total > 0 %}
                    <p class="mb-1">Entreprises: {% widthratio ca_entreprises ca_total 100 %}%</p>
                    <div class="progress mb-2">
                        <div class="progress-bar bg-primary" style="width: {% widthratio ca_entreprises ca_total 100 %}%"></div>
                    </div>

                    <p class="mb-1">Particuliers: {% widthratio ca_particuliers ca_total 100 %}%</p>
                    <div class="progress">
                        <div class="progress-bar bg-info" style="width: {% widthratio ca_particuliers ca_total 100 %}%"></div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12">
            <div class="dashboard-card">
                <h4>Résumé Financier</h4>
                <table class="table">
                    <tr>
                        <td>CA Total (Brut)</td>
                        <td class="text-end"><strong>{{ ca_total|floatformat:0 }} FCFA</strong></td>
                    </tr>
                    <tr>
                        <td>Commissions Transitaires</td>
                        <td class="text-end text-danger">- {{ commission_total|floatformat:0 }} FCFA</td>
                    </tr>
                    <tr class="table-success">
                        <td><strong>CA Net</strong></td>
                        <td class="text-end"><strong>{{ ca_net|floatformat:0 }} FCFA</strong></td>
                    </tr>
                    <tr>
                        <td>Nombre de paiements validés</td>
                        <td class="text-end">{{ nb_paiements }}</td>
                    </tr>
                    <tr>
                        <td>CA moyen par paiement</td>
                        <td class="text-end">{{ ca_moyen|floatformat:0 }} FCFA</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Graphique: CA par semaine
const ctxCASemaine = document.getElementById('chartCASemaine').getContext('2d');
new Chart(ctxCASemaine, {
    type: 'line',
    data: {
        labels: {{ chart_semaine_labels|safe }},
        datasets: [{
            label: 'CA Hebdomadaire (FCFA)',
            data: {{ chart_semaine_data|safe }},
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'bottom' }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value.toLocaleString() + ' FCFA';
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}
