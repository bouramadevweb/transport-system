{% extends 'admin.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .dashboard-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .kpi-card {
        text-align: center;
        padding: 20px;
        border-radius: 8px;
        color: white;
        transition: transform 0.2s;
    }
    .kpi-card:hover { transform: translateY(-5px); }
    .kpi-card h3 { font-size: 2em; margin: 8px 0; font-weight: bold; }
    .kpi-card p { font-size: 0.9em; opacity: 0.9; margin: 0; }
    .kpi-card small { font-size: 0.75em; opacity: 0.8; }

    .bg-total    { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .bg-valide   { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .bg-attente  { background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%); }
    .bg-net      { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .bg-comm     { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .bg-count    { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }

    .chart-container { position: relative; height: 300px; margin: 10px 0; }
    .filter-bar { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

    <!-- Titre + filtre -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h1><i class="fas fa-chart-bar"></i> {{ title }}</h1>
        <div class="filter-bar mb-0">
            <form method="get" class="d-flex align-items-center gap-2">
                <label class="mb-0 fw-semibold">Période :</label>
                <select name="period" class="form-select form-select-sm" onchange="this.form.submit()" style="width:auto;">
                    <option value="7"   {% if filter_period == '7'   %}selected{% endif %}>7 jours</option>
                    <option value="30"  {% if filter_period == '30'  %}selected{% endif %}>30 jours</option>
                    <option value="90"  {% if filter_period == '90'  %}selected{% endif %}>90 jours</option>
                    <option value="365" {% if filter_period == '365' %}selected{% endif %}>1 an</option>
                    <option value="all" {% if filter_period == 'all' %}selected{% endif %}>Tout</option>
                </select>
            </form>
        </div>
    </div>

    <!-- KPIs -->
    <div class="stats-grid">
        <div class="kpi-card bg-total">
            <p>CA Total</p>
            <h3>{{ ca_total|floatformat:0 }}</h3>
            <small>FCFA (validé + en attente)</small>
        </div>
        <div class="kpi-card bg-valide">
            <p>CA Validé</p>
            <h3>{{ ca_valide|floatformat:0 }}</h3>
            <small>FCFA</small>
        </div>
        <div class="kpi-card bg-attente">
            <p>CA En Attente</p>
            <h3>{{ ca_en_attente|floatformat:0 }}</h3>
            <small>FCFA ({{ nb_paiements_attente }} paiement{{ nb_paiements_attente|pluralize }})</small>
        </div>
        <div class="kpi-card bg-net">
            <p>CA Net (validé)</p>
            <h3>{{ ca_net|floatformat:0 }}</h3>
            <small>FCFA après commissions</small>
        </div>
        <div class="kpi-card bg-comm">
            <p>Commissions</p>
            <h3>{{ commission_total|floatformat:0 }}</h3>
            <small>FCFA transitaires</small>
        </div>
        <div class="kpi-card bg-count">
            <p>Paiements</p>
            <h3>{{ nb_paiements }}</h3>
            <small>{{ nb_paiements_valides }} validé{{ nb_paiements_valides|pluralize }} / {{ nb_paiements_attente }} en attente</small>
        </div>
    </div>

    <!-- Graphique -->
    <div class="dashboard-card">
        <h4><i class="fas fa-chart-line"></i> Évolution du CA par semaine (8 dernières semaines)</h4>
        <div class="chart-container">
            <canvas id="chartCASemaine"></canvas>
        </div>
    </div>

    <div class="row">
        <!-- Top clients -->
        <div class="col-md-8">
            <div class="dashboard-card">
                <h4><i class="fas fa-users"></i> Top 10 Clients par Chiffre d'Affaires</h4>
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Client</th>
                                <th>Type</th>
                                <th class="text-end">CA Total (FCFA)</th>
                                <th class="text-end">CA Validé (FCFA)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for client in top_clients_ca %}
                            {% if client.ca %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td><strong>{{ client.nom }}</strong></td>
                                <td><span class="badge bg-secondary">{{ client.get_type_client_display }}</span></td>
                                <td class="text-end">{{ client.ca|floatformat:0 }}</td>
                                <td class="text-end text-success"><strong>{{ client.ca_valide|default:0|floatformat:0 }}</strong></td>
                            </tr>
                            {% endif %}
                            {% empty %}
                            <tr><td colspan="5" class="text-center text-muted py-3">Aucune donnée</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Répartition CA -->
        <div class="col-md-4">
            <div class="dashboard-card">
                <h4><i class="fas fa-chart-pie"></i> Répartition par Type</h4>
                <table class="table table-sm">
                    <tr>
                        <td><strong>Entreprises</strong></td>
                        <td class="text-end">{{ ca_entreprises|floatformat:0 }} FCFA</td>
                    </tr>
                    <tr>
                        <td><strong>Particuliers</strong></td>
                        <td class="text-end">{{ ca_particuliers|floatformat:0 }} FCFA</td>
                    </tr>
                    <tr class="table-success fw-bold">
                        <td>Total</td>
                        <td class="text-end">{{ ca_total|floatformat:0 }} FCFA</td>
                    </tr>
                </table>

                {% if ca_total > 0 %}
                <div class="mt-3">
                    <p class="mb-1 small">Entreprises : {% widthratio ca_entreprises ca_total 100 %}%</p>
                    <div class="progress mb-2" style="height:12px;">
                        <div class="progress-bar bg-primary" style="width:{% widthratio ca_entreprises ca_total 100 %}%"></div>
                    </div>
                    <p class="mb-1 small">Particuliers : {% widthratio ca_particuliers ca_total 100 %}%</p>
                    <div class="progress" style="height:12px;">
                        <div class="progress-bar bg-info" style="width:{% widthratio ca_particuliers ca_total 100 %}%"></div>
                    </div>
                </div>
                {% endif %}

                <hr>
                <h5 class="mt-3"><i class="fas fa-check-circle text-success"></i> Statut des paiements</h5>
                <table class="table table-sm">
                    <tr>
                        <td><span class="badge bg-success">Validés</span></td>
                        <td class="text-end">{{ nb_paiements_valides }}</td>
                        <td class="text-end">{{ ca_valide|floatformat:0 }} FCFA</td>
                    </tr>
                    <tr>
                        <td><span class="badge bg-warning text-dark">En attente</span></td>
                        <td class="text-end">{{ nb_paiements_attente }}</td>
                        <td class="text-end">{{ ca_en_attente|floatformat:0 }} FCFA</td>
                    </tr>
                </table>
            </div>

            <div class="dashboard-card">
                <h4><i class="fas fa-calculator"></i> Résumé Financier</h4>
                <table class="table table-sm">
                    <tr><td>CA Brut Validé</td><td class="text-end"><strong>{{ ca_valide|floatformat:0 }} FCFA</strong></td></tr>
                    <tr><td>Commissions</td><td class="text-end text-danger">- {{ commission_total|floatformat:0 }} FCFA</td></tr>
                    <tr class="table-success"><td><strong>CA Net</strong></td><td class="text-end"><strong>{{ ca_net|floatformat:0 }} FCFA</strong></td></tr>
                    {% if ca_moyen %}<tr><td>CA moyen/paiement</td><td class="text-end">{{ ca_moyen|floatformat:0 }} FCFA</td></tr>{% endif %}
                </table>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const ctxCASemaine = document.getElementById('chartCASemaine').getContext('2d');
new Chart(ctxCASemaine, {
    type: 'bar',
    data: {
        labels: {{ chart_semaine_labels|safe }},
        datasets: [
            {
                label: 'CA Validé (FCFA)',
                data: {{ chart_semaine_valide|safe }},
                backgroundColor: 'rgba(17, 153, 142, 0.7)',
                borderColor: 'rgba(17, 153, 142, 1)',
                borderWidth: 1
            },
            {
                label: 'CA En Attente (FCFA)',
                data: {{ chart_semaine_attente|safe }},
                backgroundColor: 'rgba(247, 151, 30, 0.7)',
                borderColor: 'rgba(247, 151, 30, 1)',
                borderWidth: 1
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } },
        scales: {
            x: { stacked: true },
            y: {
                stacked: true,
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value.toLocaleString('fr-FR') + ' FCFA';
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}
