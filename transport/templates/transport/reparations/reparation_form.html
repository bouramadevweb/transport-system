{%extends "admin.html" %}
{%load django_bootstrap5 %}

{%block page_title %}{{title}} | Gestion Transport{%endblock %}

{%block title %}{{title}}{%endblock %}

{%block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-9">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-wrench me-2"></i>{{title}}
                    </h5>
                </div>
                <div class="card-body p-4">
                    <!-- Alerte d'aide -->
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Aide :</strong> Remplissez les informations de la réparation et sélectionnez au moins un mécanicien pour l'effectuer.
                    </div>

                    <form method="post" class="needs-validation" novalidate id="reparationForm">
                        {%csrf_token %}

                        <!-- Section 1: Informations du véhicule -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-truck text-primary me-2"></i>Informations du véhicule
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="id_camion" class="form-label">
                                            <i class="fas fa-truck me-1"></i>Camion <span class="text-danger">*</span>
                                        </label>
                                        {{ form.camion }}
                                        {%if form.camion.errors %}
                                            <div class="text-danger small mt-1">{{ form.camion.errors }}</div>
                                        {%endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="id_chauffeur" class="form-label">
                                            <i class="fas fa-user me-1"></i>Chauffeur (optionnel)
                                        </label>
                                        {{ form.chauffeur }}
                                        {%if form.chauffeur.errors %}
                                            <div class="text-danger small mt-1">{{ form.chauffeur.errors }}</div>
                                        {%endif %}
                                        <div class="form-text">
                                            <i class="fas fa-lightbulb me-1"></i>Le chauffeur qui a signalé le problème
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Détails de la réparation -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-tools text-primary me-2"></i>Détails de la réparation
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="id_date_reparation" class="form-label">
                                            <i class="fas fa-calendar me-1"></i>Date de réparation <span class="text-danger">*</span>
                                        </label>
                                        {{ form.date_reparation }}
                                        {%if form.date_reparation.errors %}
                                            <div class="text-danger small mt-1">{{ form.date_reparation.errors }}</div>
                                        {%endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="id_cout" class="form-label">
                                            <i class="fas fa-money-bill-wave me-1"></i>Coût de main-d'œuvre (FCFA) <span class="text-danger">*</span>
                                        </label>
                                        {{ form.cout }}
                                        {%if form.cout.errors %}
                                            <div class="text-danger small mt-1">{{ form.cout.errors }}</div>
                                        {%endif %}
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>Le coût des pièces sera ajouté séparément
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="id_description" class="form-label">
                                        <i class="fas fa-file-alt me-1"></i>Description de la réparation
                                    </label>
                                    {{ form.description }}
                                    {%if form.description.errors %}
                                        <div class="text-danger small mt-1">{{ form.description.errors }}</div>
                                    {%endif %}
                                    <div class="form-text">
                                        <i class="fas fa-lightbulb me-1"></i>Décrivez le problème et les travaux effectués
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 3: Mécaniciens assignés -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-user-cog text-primary me-2"></i>Mécaniciens assignés <span class="text-danger">*</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-warning" id="alert-mecaniciens">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Attention :</strong> Veuillez sélectionner au moins un mécanicien.
                                </div>

                                {%if form.mecaniciens.errors %}
                                    <div class="alert alert-danger">
                                        <i class="fas fa-times-circle me-2"></i>
                                        {{ form.mecaniciens.errors }}
                                    </div>
                                {%endif %}

                                <div class="row g-3">
                                    {%for choice in form.mecaniciens %}
                                    <div class="col-md-4 col-lg-3">
                                        <div class="card h-100 mecanicien-card" data-checkbox-id="{{ choice.id_for_label }}">
                                            <div class="card-body d-flex align-items-center">
                                                <div class="form-check">
                                                    {{ choice.tag }}
                                                    <label class="form-check-label ms-2" for="{{ choice.id_for_label }}">
                                                        <i class="fas fa-user-cog me-1"></i>
                                                        <strong>{{ choice.choice_label }}</strong>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {%endfor %}
                                </div>

                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <span id="count-mecaniciens">0</span> mécanicien(s) sélectionné(s)
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Boutons d'action -->
                        <div class="d-flex gap-2 justify-content-end mt-4">
                            <a href="{%url 'reparation_list' %}" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i> Annuler
                            </a>
                            <button type="submit" class="btn btn-primary" id="btn-submit">
                                <i class="fas fa-save me-1"></i> Enregistrer
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Carte d'aide supplémentaire -->
            <div class="card border-info mt-3 shadow-sm">
                <div class="card-body">
                    <h6 class="text-info mb-2">
                        <i class="fas fa-lightbulb me-2"></i>Informations
                    </h6>
                    <ul class="small mb-0">
                        <li>Les champs marqués d'un <span class="text-danger">*</span> sont obligatoires</li>
                        <li>Le coût de main-d'œuvre n'inclut pas les pièces (à ajouter séparément)</li>
                        <li>Au moins un mécanicien doit être assigné à la réparation</li>
                        <li>La description aide à garder un historique détaillé des interventions</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{%endblock %}

{%block extra_js %}
<script>
// Variable pour éviter les boucles infinies lors de la sélection bidirectionnelle
let isUpdating = false;

// Fonction pour charger automatiquement le chauffeur affecté au camion sélectionné
function chargerChauffeurAffecte() {
    if (isUpdating) return;

    const camionSelect = document.getElementById('id_camion');
    const chauffeurSelect = document.getElementById('id_chauffeur');

    if (!camionSelect || !chauffeurSelect) {
        return;
    }

    const camionId = camionSelect.value;

    if (!camionId) {
        return;
    }

    isUpdating = true;

    // Appel AJAX pour récupérer le chauffeur affecté au camion
    fetch(`/api/camion/${camionId}/chauffeur/`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.chauffeur_id) {
                // Sélectionner automatiquement le chauffeur
                chauffeurSelect.value = data.chauffeur_id;

                // Ajouter un effet visuel pour indiquer la sélection automatique
                chauffeurSelect.style.backgroundColor = '#d1ecf1';
                chauffeurSelect.style.border = '2px solid #0c5460';
                chauffeurSelect.title = `Chauffeur affecté : ${data.chauffeur_nom}`;

                console.log(`✅ Chauffeur affecté automatiquement : ${data.chauffeur_nom}`);
            } else {
                // Aucun chauffeur affecté, réinitialiser
                chauffeurSelect.value = '';
                chauffeurSelect.style.backgroundColor = '#fff3cd';
                chauffeurSelect.style.border = '1px solid #ffc107';
                chauffeurSelect.title = '⚠️ Aucun chauffeur affecté à ce camion';

                console.warn('⚠️ Aucun chauffeur affecté à ce camion');
            }
        })
        .catch(error => {
            console.error('❌ Erreur lors de la récupération du chauffeur:', error);
            chauffeurSelect.style.backgroundColor = '#f8d7da';
            chauffeurSelect.style.border = '1px solid #dc3545';
            chauffeurSelect.title = '❌ Erreur lors de la récupération du chauffeur';
        })
        .finally(() => {
            isUpdating = false;
        });
}

// Fonction pour charger automatiquement le camion affecté au chauffeur sélectionné
function chargerCamionAffecte() {
    if (isUpdating) return;

    const camionSelect = document.getElementById('id_camion');
    const chauffeurSelect = document.getElementById('id_chauffeur');

    if (!camionSelect || !chauffeurSelect) {
        return;
    }

    const chauffeurId = chauffeurSelect.value;

    if (!chauffeurId) {
        return;
    }

    isUpdating = true;

    // Appel AJAX pour récupérer le camion affecté au chauffeur
    fetch(`/api/chauffeur/${chauffeurId}/camion/`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.camion_id) {
                // Sélectionner automatiquement le camion
                camionSelect.value = data.camion_id;

                // Ajouter un effet visuel pour indiquer la sélection automatique
                camionSelect.style.backgroundColor = '#d1ecf1';
                camionSelect.style.border = '2px solid #0c5460';
                camionSelect.title = `Camion affecté : ${data.camion_immatriculation}`;

                console.log(`✅ Camion affecté automatiquement : ${data.camion_immatriculation}`);
            } else {
                // Aucun camion affecté, réinitialiser
                camionSelect.value = '';
                camionSelect.style.backgroundColor = '#fff3cd';
                camionSelect.style.border = '1px solid #ffc107';
                camionSelect.title = '⚠️ Aucun camion affecté à ce chauffeur';

                console.warn('⚠️ Aucun camion affecté à ce chauffeur');
            }
        })
        .catch(error => {
            console.error('❌ Erreur lors de la récupération du camion:', error);
            camionSelect.style.backgroundColor = '#f8d7da';
            camionSelect.style.border = '1px solid #dc3545';
            camionSelect.title = '❌ Erreur lors de la récupération du camion';
        })
        .finally(() => {
            isUpdating = false;
        });
}

// Gestion de la sélection des mécaniciens
function updateMecaniciensCount() {
    const checkboxes = document.querySelectorAll('input[name="mecaniciens"]');
    const count = Array.from(checkboxes).filter(cb => cb.checked).length;
    const countSpan = document.getElementById('count-mecaniciens');
    const alertMecaniciens = document.getElementById('alert-mecaniciens');

    if (countSpan) {
        countSpan.textContent = count;
    }

    // Mettre à jour l'alerte
    if (alertMecaniciens) {
        if (count > 0) {
            alertMecaniciens.className = 'alert alert-success';
            alertMecaniciens.innerHTML = '<i class="fas fa-check-circle me-2"></i><strong>Parfait !</strong> ' + count + ' mécanicien(s) sélectionné(s).';
        } else {
            alertMecaniciens.className = 'alert alert-warning';
            alertMecaniciens.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><strong>Attention :</strong> Veuillez sélectionner au moins un mécanicien.';
        }
    }

    // Mettre à jour les cartes des mécaniciens
    const cards = document.querySelectorAll('.mecanicien-card');
    cards.forEach(card => {
        const checkboxId = card.getAttribute('data-checkbox-id');
        const checkbox = document.getElementById(checkboxId);

        if (checkbox && checkbox.checked) {
            card.style.backgroundColor = '#d1ecf1';
            card.style.border = '2px solid #0c5460';
        } else {
            card.style.backgroundColor = '';
            card.style.border = '';
        }
    });
}

// Validation avant soumission
function validateForm(e) {
    const checkboxes = document.querySelectorAll('input[name="mecaniciens"]');
    const count = Array.from(checkboxes).filter(cb => cb.checked).length;

    if (count === 0) {
        e.preventDefault();
        alert('⚠️ Erreur: Veuillez sélectionner au moins un mécanicien pour cette réparation.');

        // Scroll vers la section mécaniciens
        const alertMecaniciens = document.getElementById('alert-mecaniciens');
        if (alertMecaniciens) {
            alertMecaniciens.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        return false;
    }

    return true;
}

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    // Charger le chauffeur si un camion est déjà sélectionné (mode édition)
    const camionSelect = document.getElementById('id_camion');
    if (camionSelect && camionSelect.value) {
        chargerChauffeurAffecte();
    }

    // Mettre à jour le compteur initial
    updateMecaniciensCount();

    // Écouter les changements sur les checkboxes
    const checkboxes = document.querySelectorAll('input[name="mecaniciens"]');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateMecaniciensCount);
    });

    // Rendre les cartes cliquables
    const cards = document.querySelectorAll('.mecanicien-card');
    cards.forEach(card => {
        card.style.cursor = 'pointer';
        card.addEventListener('click', function(e) {
            // Ne pas déclencher si on clique directement sur le checkbox
            if (e.target.type !== 'checkbox') {
                const checkboxId = this.getAttribute('data-checkbox-id');
                const checkbox = document.getElementById(checkboxId);
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    updateMecaniciensCount();
                }
            }
        });
    });

    // Validation du formulaire
    const form = document.getElementById('reparationForm');
    if (form) {
        form.addEventListener('submit', validateForm);
    }
});
</script>

<style>
.mecanicien-card {
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
}

.mecanicien-card:hover {
    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    transform: translateY(-2px);
}

.mecanicien-card .form-check-label {
    cursor: pointer;
    user-select: none;
}

/* Responsive */
@media (max-width: 768px) {
    .mecanicien-card {
        margin-bottom: 0.5rem;
    }
}
</style>
{%endblock %}
