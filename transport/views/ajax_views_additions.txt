# ============================================================================
# CAMIONS - AJAX CRUD OPERATIONS  
# ============================================================================

@login_required
@require_http_methods(["GET"])
def ajax_camion_create_form(request):
    """Formulaire de création camion via AJAX"""
    from ..forms.vehicle_forms import CamionForm
    form = CamionForm()
    html = render_to_string(
        'transport/camions/partials/camion_form_modal.html',
        {'form': form, 'mode': 'create'},
        request=request
    )
    return JsonResponse({'success': True, 'html': html})

@login_required
@require_http_methods(["POST"])
def ajax_camion_create(request):
    """Créer camion via AJAX"""
    from ..forms.vehicle_forms import CamionForm
    try:
        form = CamionForm(request.POST)
        if form.is_valid():
            camion = form.save()
            AuditLog.objects.create(
                utilisateur=request.user,
                action="Création camion AJAX",
                details=f"Camion: {camion.immatriculation}"
            )
            return JsonResponse({
                'success': True,
                'message': f'Camion "{camion.immatriculation}" créé avec succès'
            })
        else:
            html = render_to_string(
                'transport/camions/partials/camion_form_modal.html',
                {'form': form, 'mode': 'create'},
                request=request
            )
            return JsonResponse({
                'success': False,
                'message': 'Veuillez corriger les erreurs',
                'html': html,
                'errors': form.errors
            })
    except Exception as e:
        return JsonResponse({'success': False, 'message': str(e)}, status=500)

@login_required
@require_http_methods(["GET"])
def ajax_camion_update_form(request, pk):
    """Formulaire de modification camion via AJAX"""
    from ..forms.vehicle_forms import CamionForm
    try:
        camion = get_object_or_404(Camion, pk_camion=pk)
        form = CamionForm(instance=camion)
        html = render_to_string(
            'transport/camions/partials/camion_form_modal.html',
            {'form': form, 'mode': 'update', 'camion': camion},
            request=request
        )
        return JsonResponse({'success': True, 'html': html})
    except Exception as e:
        return JsonResponse({'success': False, 'message': str(e)}, status=500)

@login_required
@require_http_methods(["POST"])
def ajax_camion_update(request, pk):
    """Modifier camion via AJAX"""
    from ..forms.vehicle_forms import CamionForm
    try:
        camion = get_object_or_404(Camion, pk_camion=pk)
        form = CamionForm(request.POST, instance=camion)
        if form.is_valid():
            camion = form.save()
            AuditLog.objects.create(
                utilisateur=request.user,
                action="Modification camion AJAX",
                details=f"Camion: {camion.immatriculation}"
            )
            return JsonResponse({
                'success': True,
                'message': f'Camion "{camion.immatriculation}" modifié avec succès'
            })
        else:
            html = render_to_string(
                'transport/camions/partials/camion_form_modal.html',
                {'form': form, 'mode': 'update', 'camion': camion},
                request=request
            )
            return JsonResponse({
                'success': False,
                'message': 'Veuillez corriger les erreurs',
                'html': html,
                'errors': form.errors
            })
    except Exception as e:
        return JsonResponse({'success': False, 'message': str(e)}, status=500)
